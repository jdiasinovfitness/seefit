name: $(date:yyyyMMdd)$(rev:.rr)

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - client

pool: "devops-agent"

resources:
  repositories:
    - repository: templates
      type: git
      name: PRODUCT_DEVELOPMENT/PRODUCT_DEVELOPMENT

variables:
  - group: Deploy

stages:
  - stage: Build
    jobs:
      - template: azure-pipelines/build-docker-many.yml@templates
        parameters:
          App: seefit
          ServiceList:
            - "client/web"

  - stage: Deploy_tst
    displayName: "Deploy: Testing"
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.Reason'], 'PullRequest'))
    jobs:
      - template: azure-pipelines-v2/deploy-tst.yml@templates
        parameters:
          Dir: "client"
          Namespace: "seefit"
          InstallList:
            - "client"
          EnsureDeployments:
            - "web"

  - stage: Deploy_prd
    displayName: "Deploy: Production"
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.Reason'], 'IndividualCI'))
    jobs:
      - template: azure-pipelines-v2/deploy-prd.yml@templates
        parameters:
          Dir: "client"
          Namespace: "seefit"
          InstallList:
            - "client"
          EnsureDeployments:
            - "web"

  - stage: Native
    displayName: "Cordova"
    dependsOn: Build
    jobs:
      - job: Prepare
        steps:
          - task: Docker@2
            displayName: Login
            inputs:
              command: login
              containerRegistry: azurecr

          - bash: |
              CONTAINER=$(docker run -d --rm inovretail.azurecr.io/seefit/client/web:${BUILD_BUILDNUMBER})
              docker cp ${CONTAINER}:/usr/share/nginx/html www
              tar -czf www.tar.gz www
            workingDirectory: "$(Build.ArtifactStagingDirectory)"
            displayName: "Web package"

          - publish: $(Build.ArtifactStagingDirectory)/www.tar.gz
            artifact: www
              
      - job: Android
        steps:
          - checkout: self

          - download: current
            artifact: www

          - task: Docker@2
            displayName: Login
            inputs:
              command: login
              containerRegistry: azurecr

          - bash: |
              tar -xzf ${PIPELINE_WORKSPACE}/www.tar.gz www
              ls -l
            workingDirectory: $(Build.SourcesDirectory)/client/native